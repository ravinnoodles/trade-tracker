<!DOCTYPE html>
<html>
    <head>
        <title>Trade Tracker</title>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"> </script>
        <script type="text/javascript" src="js/papaparse.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <div class="col-lg-8 mx-auto p-4 py-md-5">
            <header>
                <h3>Trade Tracker</h3>
            </header>
            <section id="loading">
                <div class="col-lg-6 mx-auto p-3 py-md-3">
                    loading...
                </div>
            </section>
            <section id="tracker">
                <section>
                    <div class="btn-group" id="trainers">
    
                    </div>
                </section>
                <section id="list">
    
                </section>
            </section>
        </div>
        
        
        <script type="text/javascript">
            var public_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQN_Y-n3TjjDQtT0B89w8kXJLukdPTEPvxHrfq_qk2T9_dPqwF2_GPNFLASL019D4dvUmPlDyCARcjY/pub?gid=0&single=true&output=csv";

            var db = null;
            var data = null;

            function init() {
                $("#tracker").hide();

                $.getJSON("js/data.json", function(data) {
                    if (!db) {
                        db = data;
                    }

                    Papa.parse(public_url, {
                        download: true,
                        header: true,
                        complete: showInfo
                    })
                });

                $(".trainerButton").on("click", function() {
                    var index = $(this).attr("data");

                    if (data[index]) {
                        var needed = data[index].Needed.replaceAll('"','').split('');
                        db.regions.forEach((region) => {
                            var result = needed.filter((x) => x >= region.range.min && x <= region.range.max );

                            var header = $(`<div class="card-header">${region.name}<div>`);
                            var body = $(`<div class="card-body><h5 class="card-title">No needed Pokemon</h5></div>`);

                            if (result.length > 0) {
                                result.forEach((pokemon) => {
                                    var name = db.pokemon.find((x) => x.number == pokemon).name;
                                    body = $(`<div class="row g-0"><div class="col-md-4"><img src="img/${pokemon}.png" class="img-fluid"></div><div class="col-md-8"><div class="card-body"><h4 class="card-title">${name}</h4></div></div>`);
                                });
                            }
                            
                            var regionCard = $(`<div class="card"></div>`);
                            regionCard.append(header);
                            regionCard.append(body);

                            $("#list").append(regionCard);
                    })
                    }
                });
            }

            window.addEventListener('DOMContentLoaded', init)

            function showInfo(results) {

                data = results.data;

                data.forEach((row, i) => {
                    var btn = $(`<a href="#" class="btn btn-primary trainerButton" data="${i}">${row.Trainer}</a>`)
                    $("#trainers").append(btn);
                })
                
                $("#trainers[data='0']").click();

                $("#loading").fadeOut(400, function (){
                    $("#tracker").show();
                });
                
            }

        </script>
    </body>
</html>
